#!/bin/bash

set -e  # Exit immediately if a command exits with a non-zero status.

# Color variables for output messages
red='\e[0;31m'
green='\e[0;32m'
yellow='\e[0;33m'
clear='\e[0m'

echo -e "${yellow}ğŸ” Running ESLint...${clear}"
if ! npx eslint . --fix; then
    echo -e "${red}âŒ ESLint checks failed. Please fix the issues before committing.${clear}"
    exit 1
fi

echo -e "${yellow}ğŸ“ Running Prettier...${clear}"
if ! npx prettier --write .; then
    echo -e "${red}âŒ Prettier formatting issues found. Please format your code before committing.${clear}"
    exit 1
fi

echo -e "${yellow}ğŸ” Running TypeScript checks...${clear}"
if ! npx tsc --noEmit -p ./client/tsconfig.json; then
    echo -e "${red}âŒ TypeScript checks failed in client. Please fix the errors before committing.${clear}"
    exit 1
fi

if ! npx tsc --noEmit -p ./server/tsconfig.json; then
    echo -e "${red}âŒ TypeScript checks failed in server. Please fix the errors before committing.${clear}"
    exit 1
fi


echo -e "${yellow}ğŸ§ª Running tests...${clear}"
if ! npm test; then
    echo -e "${red}âŒ Tests failed. Please fix the errors before committing.${clear}"
    exit 1
fi

echo -e "${yellow}ğŸ”’ Running npm audit...${clear}"
if ! npm audit --exit-code; then
    echo -e "${red}âŒ Security vulnerabilities found. Please fix them before committing.${clear}"
    exit 1
fi

echo -e "${yellow}ğŸš« Checking for large files...${clear}"
for file in $(git diff --cached --name-only); do
    if [ $(wc -c < "$file") -gt 1048576 ]; then
        echo -e "${red}âŒ File $file is larger than 1MB. Please remove it from your commit.${clear}"
        exit 1
    fi
done

echo -e "${green}âœ… All checks passed! Ready to commit.${clear}"
